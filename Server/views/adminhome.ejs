<!DOCTYPE html>
<html lang="en" ng-app="admin">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-animate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-datatables/0.5.5/angular-datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/angular-datatables/0.5.5/css/angular-datatables.css">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css"> <!-- load bootstrap css -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css"> <!-- load fontawesome -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <style>
        .register-block{
            height:500px;
            margin: auto;
        }

        .register{
            width: 60%;
            margin: 5px;
        }
        .tab{
            background-color:#f5f5f0;
            line-height:50px;
            margin-bottom: 10px;
            /*width: 50%;*/
            text-align: center;
            cursor: pointer;
            padding:0px;
            /*border-right:solid 1px navajowhite*/ ;
        }
        .tab:active{
            background-color: white;
        }
        .tab:hover{
            text-decoration-color: pink;
            text-decoration: none;
        }
        body{
            padding-top: 80px;
            /*background: url('./img/background2.png');*/
        }

        nav{
            background-color: #00cca3;
        }

        #supporter{
            border-left: 1px solid antiquewhite;
        }

        .active{
            background-color: white;
            font-size: 1.2em;
        }



        .card {
            /* Add shadows to create the "card" effect */
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            transition: 0.3s;
        }

        /* On mouse-over, add a deeper shadow */
        .card:hover {
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
        }

        /* Add some padding inside the card container */
        .container-fluid {
            padding: 2px 16px;
        }

        #supporter-table{
            margin:auto;
        }

        .responsive-img{
            width:40%;
            height: 50%;
            padding: 5px;
            border: none;
        }

        .btn-effects{
            visibility: hidden;
        }
    </style>

</head>
<body ng-controller="admin-ctrl as showCase">
<nav class="navbar navbar-fixed-top" style="background-color: #00cca3">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="/">WHP</a>
        </div>
        <ul class="nav navbar-nav pull-right">
            <li class="nav-button pull-right"><a href="/user/logout">Logout</a></li>
        </ul>
    </div>
</nav>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="col-md-6 tab" id="user" ng-click="tabTransition('user')" style="color:black; font-size: 16px;">User</div>
                <div class="col-md-6 tab" id="supporter" ng-click="tabTransition('supporter')" style="color:black; font-size: 16px;">Supporter</div>
                <div class="container-fluid">
                    <div class="row">
                        <div>
                            <div ng-show="show==1"><table id="user-table" datatable="" dt-options="showCase.dtOptionsUser" dt-columns="showCase.dtColumnsUser" dt-instance="showCase.dtInstance" class="row-border hover"></table></div>
                            <div ng-show="show==2"><table id="supporter-table" datatable="" dt-options="showCase.dtOptionsSup" dt-columns="showCase.dtColumnsSup" dt-instance="showCase.dtInstance" class="row-border hover"></table></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-md-4 register-block text-center">
            <% if (message!=null) { %>
            <p class="error" style="color: #bf360c">
                <%= message.value %>
            </p>
            <%} %>
            <div ng-view></div>
        </div>
    </div>
</div>

<script>
    angular.module('admin',['datatables','ngRoute']).
    config(function($routeProvider){
        $routeProvider
                .when('/user', {
                    templateUrl: '../views/registerUser.html',
                    controller: 'UserReg-ctrl'
                })
                .when('/supporter', {
                    templateUrl: '../views/registerSupporter.html',
                    controller: 'SupporterReg-ctrl'
                })
                .when('/', {
                    templateUrl: '../views/register.html'
                    //controller: 'UserReg-ctrl'
                })
                .otherwise({redirectTo: '/'});


    }).
    controller('admin-ctrl', function ($scope, $http, $window, $compile, DTOptionsBuilder, DTColumnBuilder) {
        $scope.show=1;
        //if(sessionStorage.getItem('user'))
        var role_user = JSON.parse('<%- JSON.stringify(message) %>');
        if(role_user){
            console.log(role_user);
            location.href = '#'+role_user.role;
        }
        else{
            console.log("going");
            location.href='#/';
        }

        jQuery(document).ready(function() {
            jQuery('table').
            on('mouseover', 'tr', function(event) {
                jQuery(this).find(".btn-effects").css("visibility","visible");
            }).
            on('mouseout', 'tr', function() {
                jQuery(this).find(".btn-effects").css("visibility","hidden");
            });
        });

        $('#user').addClass("active");
        $scope.tabTransition = function (role) {
            if(role=="user"){
                $scope.show=1;
                $('#user').addClass("active");
                $('#supporter').removeClass("active");
            }
            else if(role=="supporter"){
                $scope.show=2;
                $('#user').removeClass("active");
                $('#supporter').addClass("active");
            }
            else {
                console.log("Something wrong");
            }

        }


        var vm = this;
        vm.message = '';
        vm.edit = edit;
        vm.delete = deleteRow;
        vm.dtInstance = {};
        //vm.dtInstanceSup = {};
        vm.users = {};
        //vm.someClickHandler = someClickHandler;

        vm.dtOptionsUser = DTOptionsBuilder.fromSource('/user/getAllUsers')
                .withDataProp('result')
                .withPaginationType('full_numbers')
                .withDisplayLength(5)
                .withOption('createdRow', createdRow)

        vm.dtColumnsUser = [
            DTColumnBuilder.newColumn('username').withTitle('Username'),
            DTColumnBuilder.newColumn('details.supporter').withTitle('Supporter'),
            DTColumnBuilder.newColumn('details.startDate').withTitle('Start Date'),
            DTColumnBuilder.newColumn(null).notSortable()
                    .renderWith(actionsHtml)
        ];

        vm.dtOptionsSup = DTOptionsBuilder.fromSource('/user/getAllSupporters')
                .withDataProp('result')
                .withPaginationType('full_numbers')
                .withDisplayLength(5)
                //.withOption('createdRow', createdRow)

        vm.dtColumnsSup = [
            DTColumnBuilder.newColumn('username').withTitle('Username'),
            DTColumnBuilder.newColumn('details.name').withTitle('Name'),
            //DTColumnBuilder.newColumn(null).notSortable()
                   // .renderWith(actionsHtml)
        ];

        function edit(person) {
            event.stopPropagation();
            //vm.message = 'You are trying to edit the row: ' + JSON.stringify(person);
            console.log(vm.users[person]);
            // Edit some data and call server to make changes...
            // Then reload the data so that DT is refreshed
            vm.dtInstance.reloadData();
        }

        function deleteRow(person) {
            //event.stopPropagation();
            //vm.message = 'You are trying to remove the row: ' + JSON.stringify(person);
            console.log(vm.users[person]);
            $http({
                method:"POST",
                url:"/user/deleteUser",
                data:{'username':person}
            }).then(function successCallback(response){
                console.log(response);
                //$window.alert("record deleted");
                var r = confirm("Are u sure!");
                if (r == true) {
                    $window.reload(true);
                } else {

                }
            }, function errorCallback(response){
                $window.alert(response.status);
            });
            // Delete some data and call server to make changes...
            // Then reload the data so that DT is refreshed
            vm.dtInstance.reloadData();
        }
        function createdRow(row, data, dataIndex) {
            // Recompiling so we can bind Angular directive to the DT
            $compile(angular.element(row).contents())($scope);
        }

        function actionsHtml(data, type, full, meta) {
            vm.users[data.username] = data;
            //console.log(JSON.stringify(vm.users));
            return '<div class="btn-effects"><button style="background-color: transparent;border: none;" ng-click="showCase.edit(\'' + data.username + '\')">'+
                    '   <i class="fa fa-edit"></i>' +
                    '</button>&nbsp;' +
                    '<button style="background-color: transparent;border: none;" ng-click="showCase.delete(\'' + data.username + '\')" )"="">'+
                    '   <i class="fa fa-trash-o"></i>' +
                    '</button></div>';
        }

    })
            .controller('UserReg-ctrl', function($scope, $http, $window){
                $http({
                    method:"GET",
                    url:"/user/getAllSupporters",
                }).then(function successCallback(response){
                    console.log(response);
                    $scope.data = response.data.result;
                }, function errorCallback(response){
                    $window.alert(response.status);
                });
                $scope.onCancel = function () {
                    $(".error").hide();
                    location.href='#/';
                }
            })

            .controller('SupporterReg-ctrl', function($scope, $http){
                $scope.onCancel = function () {
                    $(".error").hide();
                    location.href='#/';
                }
            });

</script>
</body>
</html>